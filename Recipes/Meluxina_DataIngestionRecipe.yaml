meta:
  name: "minio-ingestion-benchmark-meluxina"
  description: "Benchmark MinIO ingestion distribuito su nodi HPC Meluxina."
  author: "LucaLM02"
  created_at: "2025-10-31T00:00:00Z"
  commit: "b4e5c6d7"

global:
  workspace: "${WORKSPACE}"
  timeout: 3600
  environment:
    - BENCH_MODE=single-node

# ------------------------------------------------------------------
# SERVICES (server) → Apptainer OR Slurm
# ------------------------------------------------------------------
services:
  - id: "minio-01"
    role: "storage"

    executor:
      type: "process"

    command: |
      export MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      export MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
      export MINIO_PROMETHEUS_AUTH_TYPE=${MINIO_PROMETHEUS_AUTH_TYPE:-public}
      mkdir -p ${WORKSPACE}/minio-data
      # Default to the public "latest" tag because several Meluxina nodes do not
      # mirror the more recent RELEASE.* tags from Docker Hub. Operators can
      # still pin an explicit tag by exporting MINIO_IMAGE_TAG before running
      # the benchmark.
      MINIO_IMAGE_TAG=${MINIO_IMAGE_TAG:-latest}
      apptainer exec --bind ${WORKSPACE}/minio-data:/data docker://minio/minio:${MINIO_IMAGE_TAG} \
        minio server /data --console-address :9001 --address :9000

    healthcheck:
      type: "http"
      url: "http://127.0.0.1:9000/minio/health/ready"
      expect_status: 200
      interval: 5
      timeout: 120

    monitor: "prometheus-node"
    logger: "file-compact"

# ------------------------------------------------------------------
# CLIENTS (carico) → Slurm + Apptainer
# ------------------------------------------------------------------
clients:
  - id: "s3-uploader-1"
    type: "s3-upload"

    executor:
      type: "workload"

    workload:
      type: "s3-upload"
      endpoint: "http://127.0.0.1:9000"
      health_path: "/minio/health/ready"
      objects: 100
      size_kb: 64
      delay: 0.05
      timeout: 2
      label: "single-node-ingestion"

    monitor: "prometheus-node"
    logger: "file-compact"

    retries:
      attempts: 2
      backoff: 5

# ------------------------------------------------------------------
# MONITORING
# ------------------------------------------------------------------
monitors:
  - id: "prometheus-node"
    type: "prometheus"
    targets: ["127.0.0.1:9000"]
    scrape_interval: 5
    collect_interval: 10
    save_as: "prom_snapshot.json"
    metrics_path: "/minio/v2/metrics/cluster"

# ------------------------------------------------------------------
# LOGGING
# ------------------------------------------------------------------
loggers:
  - id: "file-compact"
    type: "file"
    paths:
      - "${global.workspace}/logs"
    file_name: "minio_ingest.log"
    format: "json"

# ------------------------------------------------------------------
# EXECUTION
# ------------------------------------------------------------------
execution:
  warmup: 30
  duration: 60
  replicas: 1
  poll_interval: 5
  post_actions:
    - collect_metrics
    - stop_services

# ------------------------------------------------------------------
# REPORTING
# ------------------------------------------------------------------
reporting:
  outputs:
    - type: "csv"
      file: "${global.workspace}/metrics_summary.csv"
    - type: "pdf"
      file: "${global.workspace}/final_report.pdf"

notifications:
  webhook: ""

cleanup:
  remove_containers: true
  preserve_artifacts: false
